<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Mod Manager</title>
    
    <!-- Tailwind CSS (CDN for simple host) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME ICONS (CDN for compatibility) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" />

    <!-- REACT, BABEL, FIREBASE CORE LIBRARIES -->
    <!-- These must load first to define global variables -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>

    <!-- Firebase SDKs (Defined globally for the app) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        /* Ensures the entire page background is dark slate */
        html, body {
            background-color: #0f172a; 
            min-height: 100vh;
        }
        /* Fix for scrollbar in modal on dark background */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #1e293b; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // ====================================================================================
        // --- START OF COMBINED APPLICATION LOGIC (ModManager.jsx) ---
        // ====================================================================================

        const { useState, useEffect, useCallback, useRef, useMemo } = React;
        const MODRINTH_API_BASE = "https://api.modrinth.com/v2";

        // --- Custom Hooks ---
        function useDebounce(value, delay) {
          const [debouncedValue, setDebouncedValue] = useState(value);
          useEffect(() => {
            const handler = setTimeout(() => {
              setDebouncedValue(value);
            }, delay);
            return () => {
              clearTimeout(handler);
            };
          }, [value, delay]);
          return debouncedValue;
        }

        // ------------------------------------------------------------------
        // --- FIREBASE SETUP ---
        // ------------------------------------------------------------------
        const manualConfig = {
            apiKey: "AIzaSyAKmyXDM-1YbhWD8rPxszq1o9RxP918bKU",
            authDomain: "modrinth-manager.firebaseapp.com",
            projectId: "modrinth-manager",
            storageBucket: "modrinth-manager.firebasestorage.app",
            messagingSenderId: "567380643150",
            appId: "1:567380643150:web:8683fe9269ff817a6f221f",
            measurementId: "G-48CPQ9VVJM"
        };

        const getFirebaseConfig = () => {
            if (manualConfig.apiKey) return manualConfig;
            return {}; 
        };

        const firebaseConfig = getFirebaseConfig();
        
        // Access Firebase functions globally
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        const storageAppId = 'default-mod-manager'; 

        const MC_VERSIONS = [
            "1.21.11", "1.21.10", "1.21.9", "1.21.8", "1.21.7", "1.21.6", "1.21.5", 
            "1.21.4", "1.21.3", "1.21.2", "1.21.1", "1.21", 
            "1.20.6", "1.20.4", "1.20.2", "1.20.1", 
            "1.19.4", "1.19.2", "1.18.2", "1.16.5"
        ];
        
        // --- Shared Icon Component (Using Font Awesome) ---
        const Icon = ({ name, className = "" }) => <i className={`fa-solid fa-${name} ${className}`} />;

        // --- Components ---

        const Card = ({ children, className = "" }) => (
          <div className={`bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-sm ${className}`}>
            {children}
          </div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, title = "", type = "button" }) => {
          const baseStyle = "px-4 py-2 rounded font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
          const variants = {
            primary: "bg-emerald-600 hover:bg-emerald-500 text-white",
            secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
            danger: "bg-red-900/20 hover:bg-red-900/40 text-red-400 border border-red-900/50",
            ghost: "hover:bg-slate-700/50 text-slate-400 hover:text-slate-200",
            outline: "border border-slate-600 hover:border-slate-500 text-slate-300 hover:bg-slate-800",
            purple: "bg-purple-600 hover:bg-purple-500 text-white"
          };
          
          return (
            <button 
              onClick={onClick} 
              className={`${baseStyle} ${variants[variant]} ${className}`}
              disabled={disabled}
              title={title}
              type={type}
            >
              {children}
            </button>
          );
        };

        const Badge = ({ children, color = "slate" }) => {
          const colors = {
            slate: "bg-slate-700 text-slate-300",
            green: "bg-emerald-900/50 text-emerald-400 border border-emerald-800",
            yellow: "bg-amber-900/50 text-amber-400 border border-amber-800",
            red: "bg-red-950/80 text-red-300 border border-red-900/50", 
            purple: "bg-purple-900/50 text-purple-400 border border-purple-800",
          };
          
          return (
            <span className={`px-2 py-0.5 rounded text-xs font-medium ${colors[color]}`}>
              {children}
            </span>
          );
        };

        // --- Helper Logic ---

        const generateCode = (prefix) => {
          const chars = '23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // No 0,1,I,O for readability
          let result = '';
          for (let i = 0; i < 4; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
          return `${prefix}-${result}`; // e.g. ADM-X92Z
        };

        const copyToClipboard = (text) => {
          const textArea = document.createElement("textarea");
          textArea.value = text;
          textArea.style.position = "fixed";
          textArea.style.left = "-9999px";
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            return true;
          } catch (err) {
            console.error('Failed to copy', err);
            return false;
          } finally {
            document.body.removeChild(textArea);
          }
        };

        const resolveDependencyName = async (depId) => {
            try {
                const response = await fetch(`${MODRINTH_API_BASE}/project/${depId}`);
                if (!response.ok) return null;
                const json = await response.json();
                return { id: json.id, slug: json.slug, title: json.title };
            } catch (e) { return null; }
        }
        
        // --- Sub-Components ---

        const ScriptModal = ({ isOpen, onClose, mods, targetVersion, syncedVersion }) => {
          const [scriptType, setScriptType] = useState('bash'); 
          const [copied, setCopied] = useState(false);

          // Use syncedVersion for the script header if available, otherwise target
          const effectiveVersion = syncedVersion || targetVersion;
          const isMismatch = syncedVersion && targetVersion && syncedVersion !== targetVersion;

          useEffect(() => {
             if (typeof navigator !== 'undefined' && navigator.userAgent.indexOf("Win") !== -1) {
                 setScriptType('powershell');
             }
          }, []);
          
          if (!isOpen) return null;

          // Filter for READY mods AND ENABLED mods
          const readyMods = mods.filter(m => 
              (m.enabled !== false) && 
              ((m.target_version_number !== 'None Found') || (m.isCustom && m.status === 'ready'))
          );
          const uniqueMods = [...new Map(readyMods.map(item => [item.slug, item])).values()];

          let script = "";

          if (scriptType === 'bash') {
              script += `#!/bin/bash\n# Auto-generated Mod Migration Script for ${effectiveVersion}\n`;
              script += `# Contains ${uniqueMods.length} unique mods\n\n`;
              
              script += `# Check if we are already in a 'mods' folder\n`;
              script += `if [[ $(basename "$PWD") != "mods" ]]; then\n`;
              script += `  mkdir -p mods\n`;
              script += `  cd mods\n`;
              script += `fi\n\n`;
              
              uniqueMods.forEach(mod => {
                const url = mod.primary_file_url || mod.target_file_url || mod.customUrl;
                // For custom mods without URL, we skip download but echo a reminder
                if (mod.isCustom && !url) {
                    script += `# ${mod.title} (Custom - Manual Install)\n`;
                    script += `echo "Reminder: Please manually install ${mod.title}"\n\n`;
                    return;
                }

                // Use simple slug for custom mods, standard format for Modrinth mods
                const filename = mod.isCustom 
                    ? `${mod.slug}.jar` 
                    : `${mod.slug}-${mod.target_version_number}.jar`;
                
                // SMART UPDATE LOGIC (Bash)
                script += `# ${mod.title}\n`;
                script += `if [ ! -f "${filename}" ]; then\n`;
                script += `  echo "Updating ${mod.title}..."\n`;
                script += `  rm -f "${mod.slug}"-*.jar\n`; 
                script += `  wget -q --show-progress -O "${filename}" "${url}"\n`; 
                script += `else\n`;
                script += `  echo "Skipping ${mod.title} (Already up to date)"\n`;
                script += `fi\n\n`;
              });
          } else {
              // PowerShell Script
              script += `# Auto-generated Mod Migration Script for ${effectiveVersion}\n`;
              script += `# Contains ${uniqueMods.length} unique mods\n\n`;
              
              // SMART FOLDER DETECTION (PowerShell)
              script += `# Check if we are already in a 'mods' folder\n`;
              script += `if ((Get-Item .).Name -ne 'mods') {\n`;
              script += `    New-Item -ItemType Directory -Force -Path mods | Out-Null\n`;
              script += `    Set-Location mods\n`;
              script += `}\n\n`;
              
              uniqueMods.forEach(mod => {
                const url = mod.primary_file_url || mod.target_file_url || mod.customUrl;
                
                if (mod.isCustom && !url) {
                    script += `# ${mod.title} (Custom - Manual Install)\n`;
                    script += `Write-Host "Reminder: Please manually install ${mod.title}" -ForegroundColor Yellow\n\n`;
                    return;
                }

                const filename = mod.isCustom 
                    ? `${mod.slug}.jar` 
                    : `${mod.slug}-${mod.target_version_number}.jar`;
                
                // SMART UPDATE LOGIC (PowerShell)
                script += `# ${mod.title}\n`;
                script += `if (-not (Test-Path "${filename}")) {\n`;
                script += `    Write-Host "Updating ${mod.title}..."\n`;
                script += `    Remove-Item "${mod.slug}-*.jar" -ErrorAction SilentlyContinue\n`;
                script += `    Invoke-WebRequest -Uri "${url}" -OutFile "${filename}"\n`;
                script += `} else {\n`;
                script += `    Write-Host "Skipping ${mod.title} (Already up to date)"\n`;
                script += `}\n\n`;
              });
          }

          script += `\n${scriptType === 'bash' ? 'echo' : 'Write-Host'} "Download complete! ${uniqueMods.length} mods processed."`;

          const handleCopy = () => {
              const success = copyToClipboard(script);
              if (success) {
                  setCopied(true);
                  setTimeout(() => setCopied(false), 2000);
              }
          };

          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
              <div className="bg-slate-800 border border-slate-700 rounded-xl w-full max-w-3xl p-6 shadow-2xl">
                <div className="flex justify-between items-center mb-4">
                  <div>
                      <h3 className="text-xl font-bold text-white flex items-center gap-2">
                        <Icon name="terminal" className="w-5 h-5 text-emerald-400" /> Server Download Script
                      </h3>
                      {isMismatch && (
                          <p className="text-xs text-amber-400 flex items-center gap-1 mt-1">
                              <Icon name="triangle-exclamation" className="w-3 h-3" /> Warning: Mods are synced to <strong>{syncedVersion}</strong>, but target is <strong>{targetVersion}</strong>.
                          </p>
                      )}
                  </div>
                  <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon name="x" className="w-5 h-5" /></button>
                </div>
                
                <div className="flex gap-2 mb-4 p-1 bg-slate-900/50 rounded-lg border border-slate-700 w-fit">
                    <button 
                        onClick={() => setScriptType('bash')}
                        className={`px-3 py-1 rounded text-xs font-bold transition-colors ${scriptType === 'bash' ? 'bg-emerald-600 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                        Bash (Linux/Mac)
                    </button>
                    <button 
                        onClick={() => setScriptType('powershell')}
                        className={`px-3 py-1 rounded text-xs font-bold transition-colors ${scriptType === 'powershell' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                        PowerShell (Windows)
                    </button>
                </div>

                <p className="text-slate-400 text-sm mb-3">
                  Run this in your <strong>{scriptType === 'bash' ? 'Terminal' : 'PowerShell'}</strong> to download all <strong>{uniqueMods.length} Ready</strong> mods. 
                  <br/><span className="text-amber-400 text-xs">Note: Ensure you are in your server's root folder before running.</span>
                </p>
                <div className="bg-slate-950 border border-slate-700 rounded p-3 mb-4 relative group overflow-hidden">
                  <pre className="text-xs font-mono text-emerald-400 break-all block max-h-[400px] overflow-y-auto whitespace-pre-wrap">
                    {script}
                  </pre>
                </div>
                <div className="flex justify-end gap-3">
                  <Button variant="secondary" onClick={onClose}>Close</Button>
                  <Button onClick={handleCopy} className={copied ? "bg-emerald-600 hover:bg-emerald-500 border-emerald-500" : ""}>
                    {copied ? <Icon name="check" className="w-4 h-4" /> : <Icon name="copy" className="w-4 h-4" />} 
                    {copied ? "Copied!" : "Copy Script"}
                  </Button>
                </div>
              </div>
            </div>
          );
        };

        const NoteInput = ({ initialValue, onSave, isLocked = false }) => {
          const [value, setValue] = useState(initialValue || '');
          const [saved, setSaved] = useState(true);

          useEffect(() => {
            setValue(initialValue || '');
          }, [initialValue]);

          const handleChange = (e) => {
            setValue(e.target.value);
            setSaved(false);
          };

          const handleBlur = () => {
            if (value !== initialValue) {
              onSave(value);
              setSaved(true);
            }
          };

          if (isLocked) {
             return (
                <div className="mt-3 bg-slate-900/50 border-l-2 border-slate-600 rounded-r-md p-3 flex items-center gap-3 opacity-75">
                    <Icon name="lock" className="w-3 h-3 text-slate-500 shrink-0" title="Locked by author" />
                    <p className="text-xs text-slate-400 italic w-full break-words leading-relaxed">{value}</p>
                </div>
             );
          }

          return (
            <div className="mt-3 bg-slate-950 border-l-2 border-yellow-500 rounded-r-md p-3 relative group transition-all hover:bg-slate-900">
                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    {saved ? <Icon name="check-circle" className="w-3 h-3 text-emerald-500" /> : <Icon name="save" className="w-3 h-3 text-amber-500 animate-pulse" />}
                </div>
                <div className="flex items-center gap-3">
                    <Icon name="file-lines" className="w-3 h-3 text-yellow-500 shrink-0" />
                    <textarea
                        value={value}
                        onChange={handleChange}
                        onBlur={handleBlur}
                        placeholder="Add a note..."
                        className="w-full bg-transparent border-none text-xs text-slate-200 placeholder:text-slate-600 focus:ring-0 p-0 resize-none h-auto min-h-[1.5em] leading-relaxed"
                        rows={1}
                        style={{ fieldSizing: 'content' }}
                    />
                </div>
            </div>
          );
        };

        // --- Custom Mod Modal (Includes File Upload) ---
        const CustomModModal = ({ isOpen, onClose, onAdd }) => {
            const [name, setName] = useState('');
            const [desc, setDesc] = useState('');
            const [url, setUrl] = useState('');
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);

            if (!isOpen) return null;

            const handleFileChange = (e) => {
                if (e.target.files[0]) {
                    setFile(e.target.files[0]);
                    setUrl(''); // Clear URL if file selected
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!name.trim()) return;
                
                let finalUrl = url;

                if (file) {
                    setUploading(true);
                    try {
                        // Upload to Firebase Storage
                        const storageRef = storage.ref();
                        // Sanitize filename but keep extension
                        const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g, '');
                        const fileRef = storageRef.child(`uploads/${safeName}`);
                        
                        await fileRef.put(file);
                        finalUrl = await fileRef.getDownloadURL();
                    } catch (err) {
                        console.error("Upload failed", err);
                        alert("Upload failed! Check console or Firebase Rules.");
                        setUploading(false);
                        return;
                    }
                    setUploading(false);
                }

                onAdd(name, desc, finalUrl);
                setName('');
                setDesc('');
                setUrl('');
                setFile(null);
                onClose();
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="xmark" className="w-5 h-5" /></button>
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <Icon name="file-arrow-up" className="w-5 h-5 text-purple-500" /> Add Custom Mod
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Mod Name</label>
                                <input autoFocus type="text" value={name} onChange={e => setName(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none" placeholder="e.g. My Private Plugin" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                                <textarea value={desc} onChange={e => setDesc(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none h-20 resize-none" placeholder="What does it do?" />
                            </div>
                            
                            {/* File Upload Section */}
                            <div className="bg-slate-950 border border-slate-800 rounded-lg p-3">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Upload JAR File</label>
                                <input 
                                    type="file" 
                                    accept=".jar,.zip" 
                                    onChange={handleFileChange}
                                    className="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-900/30 file:text-purple-400 hover:file:bg-purple-900/50"
                                />
                                {file && <p className="text-[10px] text-emerald-400 mt-2"><Icon name="check" className="w-3 h-3" /> Ready to upload: {file.name}</p>}
                            </div>

                            <div className="relative flex items-center py-2">
                                <div className="flex-grow border-t border-slate-700"></div>
                                <span className="flex-shrink-0 mx-2 text-slate-600 text-xs">OR USE URL</span>
                                <div className="flex-grow border-t border-slate-700"></div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Direct Download URL</label>
                                <input 
                                    type="text" 
                                    value={url} 
                                    onChange={e => { setUrl(e.target.value); setFile(null); }} 
                                    disabled={!!file}
                                    className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-purple-500 outline-none font-mono text-xs disabled:opacity-50" 
                                    placeholder={file ? "File selected (URL disabled)" : "https://..."} 
                                />
                            </div>
                            
                            <Button type="submit" disabled={!name.trim() || uploading} variant="purple" className="w-full mt-2">
                                {uploading ? <span className="animate-pulse">Uploading...</span> : "Add Custom Mod"}
                            </Button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- NEW: Server Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, initialName, initialIP, initialUrl, onSave }) => {
            const [name, setName] = useState(initialName);
            const [ip, setIp] = useState(initialIP);
            const [panelUrl, setPanelUrl] = useState(initialUrl || '');

            // Update local state when props change (e.g. data load)
            useEffect(() => {
                setName(initialName);
                setIp(initialIP);
                setPanelUrl(initialUrl || '');
            }, [initialName, initialIP, initialUrl, isOpen]);

            if (!isOpen) return null;

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(name, ip, panelUrl);
                onClose();
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-md p-6 shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="xmark" className="w-5 h-5" /></button>
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <Icon name="gear" className="w-5 h-5 text-slate-400" /> Server Settings
                        </h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Server Name</label>
                                <input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white focus:border-emerald-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Server IP Address</label>
                                <input type="text" value={ip} onChange={e => setIp(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white font-mono text-sm focus:border-emerald-500 outline-none" placeholder="play.myserver.com" />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">PloxHost/Panel URL</label>
                                <input type="text" value={panelUrl} onChange={e => setPanelUrl(e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded p-2 text-white font-mono text-sm focus:border-emerald-500 outline-none" placeholder="https://panel.ploxhost.com/server/..." />
                                <p className="text-[10px] text-slate-500 mt-1">Paste the link to your PloxHost console here to add a quick-access button.</p>
                            </div>
                            <Button type="submit" variant="primary" className="w-full mt-2">Save Settings</Button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- In-Card Dependency Section (Fixed Flickering) ---
        const DependencySection = ({ mod, allMods, onAdd, onEdit }) => {
            const [dependencyInfo, setDependencyInfo] = useState({}); // Cache for titles { id: {title, slug} }
            
            // 1. Fetch effect: ONLY fetch info for dependencies we haven't seen yet.
            // This does NOT rerun when 'allMods' updates, preserving the data.
            useEffect(() => {
                if (!mod.dependencies) return;
                
                const fetchMissing = async () => {
                    const updates = {};
                    let needsUpdate = false;
                    
                    for (const dep of mod.dependencies) {
                        if (dep.dependency_type !== 'required') continue;
                        if (dependencyInfo[dep.project_id]) continue; // Already cached
                        
                        // Check if we can just grab it from the loaded mod list (instant)
                        const localMod = allMods.find(m => m.id === dep.project_id);
                        if (localMod) {
                             updates[dep.project_id] = { title: localMod.title, slug: localMod.slug };
                             needsUpdate = true;
                        } else {
                             // Otherwise, fetch it from Modrinth API
                             const info = await resolveDependencyName(dep.project_id);
                             if (info) {
                                 updates[dep.project_id] = { title: info.title, slug: info.slug };
                                 needsUpdate = true;
                             }
                        }
                    }
                    
                    if (needsUpdate) {
                        setDependencyInfo(prev => ({ ...prev, ...updates }));
                    }
                };
                fetchMissing();
            }, [mod.dependencies, allMods]); 

            // 2. Compute View: Calculate "Installed" status efficiently during render.
            // This is fast and synchronous, preventing the loading state flicker.
            const displayDeps = useMemo(() => {
                if (!mod.dependencies) return [];
                
                return mod.dependencies
                    .filter(d => d.dependency_type === 'required')
                    .map(dep => {
                        const localMod = allMods.find(m => m.id === dep.project_id);
                        const info = dependencyInfo[dep.project_id] || {};
                        
                        return {
                            ...dep,
                            status: localMod ? 'installed' : 'missing',
                            // Title precedence: Local Installed > Cached API > Fallback
                            title: localMod ? localMod.title : (info.title || 'Loading...'),
                            slug: localMod ? localMod.slug : info.slug,
                            modData: localMod
                        };
                    });
            }, [mod.dependencies, allMods, dependencyInfo]);

            if (!displayDeps.length) return null;

            return (
                <div className="mt-4 pt-3 border-t border-slate-700/50">
                    <h4 className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 flex items-center gap-1">
                        <Icon name="link" className="w-3 h-3" /> Dependencies
                    </h4>
                    <div className="flex flex-wrap gap-2">
                        {displayDeps.map((dep, idx) => (
                            <button 
                                key={`${mod.id}-dep-${idx}`}
                                onClick={(e) => {
                                    if(dep.status === 'missing' && dep.slug) onAdd(e, dep.slug);
                                    if(dep.status === 'installed' && dep.modData) onEdit(dep.modData.id); 
                                }}
                                disabled={dep.status === 'missing' && !dep.slug}
                                className={`flex items-center gap-2 px-2 py-1 rounded border text-xs transition-all ${
                                    dep.status === 'installed' 
                                        ? 'bg-emerald-900/10 border-emerald-900/30 text-emerald-400 hover:bg-emerald-900/30 cursor-pointer group' 
                                        : 'bg-red-900/10 border-red-900/30 text-red-400 hover:bg-red-900/30'
                                }`}
                            >
                                {dep.status === 'installed' ? (
                                    <Icon name="circle-check" className="w-3 h-3" />
                                ) : (
                                    <Icon name="triangle-exclamation" className="w-3 h-3" />
                                )}
                                
                                <span className="font-medium">{dep.title}</span>
                                
                                {dep.status === 'missing' && dep.slug && (
                                    <span className="ml-1 px-1.5 py-0.5 bg-red-500 text-white rounded text-[10px] font-bold flex items-center gap-0.5">
                                        <Icon name="plus" className="w-2 h-2" /> ADD
                                    </span>
                                )}

                                {dep.status === 'installed' && (
                                     <Icon name="pen-to-square" className="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity" />
                                )}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const ModCard = ({ mod, allMods, isCheckingUpdates, accessLevel, activeTab, onVersionChange, onApprove, onRemove, onAddDependency, onEditDependency, isModal = false, onUpdateNote, currentUser, onVote, onToggle }) => {
            
            const isLocked = mod.note && mod.noteAuthorId && mod.noteAuthorId !== currentUser?.uid && accessLevel !== 'admin';
            // NEW: Enabled logic (default to true if undefined)
            const isEnabled = mod.enabled !== false; 
            
            const upvotes = mod.upvotes || [];
            const downvotes = mod.downvotes || [];
            const hasUpvoted = currentUser && upvotes.includes(currentUser.uid);
            const hasDownvoted = currentUser && downvotes.includes(currentUser.uid);

            // STYLE UPDATE: 
            // - If disabled: Dimmed & Grayscale
            // - Else if outdated: Red
            // - Else: Standard
            let cardStatusStyle = 'hover:bg-slate-800/80';
            
            if (!isEnabled) {
                cardStatusStyle = 'opacity-60 grayscale';
            } else if (mod.target_version_number === 'None Found' && !mod.isCustom) {
                cardStatusStyle = 'bg-red-950/80 border-red-900/50';
            }

            return (
                <Card className={`p-4 transition-all duration-300 ${isCheckingUpdates ? 'opacity-70' : 'opacity-100'} ${cardStatusStyle}`}>
                    <div className="flex flex-col md:flex-row md:items-center gap-4 justify-between">
                    
                    {/* Mod Info */}
                    <div className="flex items-start gap-4 flex-1">
                        {mod.icon_url ? (
                            <img src={mod.icon_url} className="w-12 h-12 rounded bg-slate-900 object-cover" /> 
                        ) : (
                            <div className="w-12 h-12 rounded bg-slate-900 flex items-center justify-center">
                                {mod.isCustom ? <Icon name="file" className="w-6 h-6 text-purple-400" /> : <Icon name="cube" className="w-6 h-6 text-slate-400" />}
                            </div>
                        )}
                        <div>
                        <div className="flex items-center gap-3 mb-1">
                            <h3 className="font-bold text-lg text-slate-200">{mod.title}</h3>
                            {/* Status Badge Logic */}
                            {!isEnabled ? (
                                <Badge color="slate">Disabled</Badge>
                            ) : mod.isCustom ? (
                                <Badge color="purple">Custom</Badge>
                            ) : (
                                mod.target_version_number === 'None Found' ? <Badge color="red">Outdated</Badge> : <Badge color="green">Ready</Badge>
                            )}
                            <a href={mod.project_url || '#'} target="_blank" rel="noreferrer" className="text-slate-500 hover:text-emerald-400 transition-colors"><Icon name="external-link" className="w-4 h-4" /></a>
                        </div>
                        <p className="text-sm text-slate-400 line-clamp-1 max-w-xl">{mod.description}</p>
                        
                        {/* Wishlist Note Input */}
                        {activeTab === 'wishlist' && (
                            <NoteInput 
                                initialValue={mod.note} 
                                isLocked={isLocked}
                                onSave={(val) => onUpdateNote(mod.id, val, currentUser?.uid)}
                            />
                        )}
                        </div>
                    </div>

                    {/* Versions Dropdown - Disabled if User & Active Tab */}
                    {activeTab === 'active' && (
                        mod.isCustom ? (
                            <div className="flex items-center justify-center bg-slate-900/50 p-3 rounded-lg border border-slate-700/50 min-w-[200px] text-slate-400 text-sm font-mono gap-2">
                                <Icon name="file-arrow-up" className="text-purple-500" /> 
                                <span>{mod.customUrl ? 'URL Linked' : 'Manual Install'}</span>
                            </div>
                        ) : (
                            <div className="flex items-center gap-6 bg-slate-900/50 p-3 rounded-lg border border-slate-700/50">
                                <div className="flex flex-col items-end min-w-[140px]">
                                    <span className="text-[10px] text-slate-500 font-bold uppercase mb-1">Installed</span>
                                    <div className="relative w-full">
                                    <select 
                                        value={mod.installed_version}
                                        onChange={(e) => onVersionChange(mod.id, e.target.value)}
                                        disabled={accessLevel === 'user'} 
                                        className="w-full appearance-none bg-slate-800 border border-slate-600 hover:border-slate-500 text-slate-300 text-sm font-mono py-1 pl-2 pr-6 rounded cursor-pointer focus:outline-none focus:ring-1 focus:ring-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        {!mod.server_candidates || mod.server_candidates.length === 0 
                                        ? <option>No Ver</option> 
                                        : [...new Set(mod.server_candidates)].map(v => <option key={v} value={v}>{v}</option>)
                                        }
                                    </select>
                                    {accessLevel === 'admin' && <Icon name="chevron-down" className="w-3 h-3 text-slate-500 absolute right-2 top-2 pointer-events-none" />}
                                    </div>
                                </div>
                                <Icon name="arrow-right" className="w-4 h-4 text-slate-600" />
                                {/* Target Version Display (Read Only) */}
                                <div className="flex flex-col items-start min-w-[140px]">
                                    <span className="text-[10px] text-emerald-500/70 font-bold uppercase mb-1">Target</span>
                                    <div className="flex items-center gap-2 h-[28px]">
                                    <span className={`font-mono text-sm font-bold ${mod.target_version_number === 'None Found' ? 'text-red-400' : 'text-emerald-400'}`}>
                                        {mod.target_version_number === 'None Found' ? 'Not Ready' : mod.target_version_number}
                                    </span>
                                    </div>
                                </div>
                            </div>
                        )
                    )}
                    
                    {/* Actions */}
                    <div className="flex items-center gap-2">
                        
                        {/* Toggle Button (Admin & Active Only) */}
                        {accessLevel === 'admin' && activeTab === 'active' && (
                            <button 
                                onClick={() => onToggle(mod.id)} 
                                className="p-2 rounded hover:bg-slate-700/50 transition-colors"
                                title={isEnabled ? "Disable Mod" : "Enable Mod"}
                            >
                                <Icon 
                                    name={isEnabled ? "toggle-on" : "toggle-off"} 
                                    className={`text-4xl transition-colors ${isEnabled ? "text-emerald-400" : "text-slate-500"}`} 
                                />
                            </button>
                        )}

                        {/* Voting Controls (Wishlist Only) */}
                        {activeTab === 'wishlist' && (
                            <div className="flex items-center gap-2 bg-slate-900/50 rounded-lg px-2 py-1.5 border border-slate-700 mr-2">
                                <button 
                                    onClick={() => onVote(mod.id, 'up')}
                                    className={`flex items-center gap-1.5 px-1.5 rounded hover:bg-slate-800 transition-colors ${hasUpvoted ? 'text-emerald-400' : 'text-slate-500 hover:text-emerald-300'}`}
                                    title="Vote Up"
                                >
                                    <Icon name="thumbs-up" className="w-4 h-4" />
                                    <span className="text-xs font-bold font-mono">{upvotes.length}</span>
                                </button>
                                
                                <div className="w-px h-4 bg-slate-700"></div>
                                
                                <button 
                                    onClick={() => onVote(mod.id, 'down')}
                                    className={`flex items-center gap-1.5 px-1.5 rounded hover:bg-slate-800 transition-colors ${hasDownvoted ? 'text-red-400' : 'text-slate-500 hover:text-red-300'}`}
                                    title="Vote Down"
                                >
                                    <Icon name="thumbs-down" className="w-4 h-4" />
                                    <span className="text-xs font-bold font-mono">{downvotes.length}</span>
                                </button>
                            </div>
                        )}

                        {/* Approve (Admin + Wishlist only) */}
                        {activeTab === 'wishlist' && accessLevel === 'admin' && (
                            <button onClick={() => onApprove(mod)} title="Promote to Server Mods" className="p-2 text-yellow-400 bg-yellow-900/20 hover:bg-yellow-900/40 border border-yellow-900/30 rounded transition-colors">
                                <Icon name="star" className="w-5 h-5" />
                            </button>
                        )}
                        
                        {/* Delete (Admin always, User only in Wishlist) */}
                        {(accessLevel === 'admin' || activeTab === 'wishlist') && (
                            <button onClick={() => onRemove(mod.id)} title="Remove Mod" className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-900/20 rounded transition-colors">
                                <Icon name="trash-can" className="w-5 h-5" />
                            </button>
                        )}
                    </div>
                    </div>

                    {/* Dependency Section (Shows BOTH Installed and Missing) */}
                    {activeTab === 'active' && !isModal && (
                        <DependencySection mod={mod} allMods={allMods} onAdd={onAddDependency} onEdit={onEditDependency} />
                    )}
                </Card>
            );
        };

        // --- Dependency Edit Modal (DEFINED BEFORE USE) ---
        const DependencyModal = ({ mod, allMods, isOpen, onClose, onRemove, onUpdateNote, ...props }) => {
            if (!isOpen || !mod) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                     <div className="bg-slate-900 border border-slate-700 rounded-xl w-full max-w-4xl p-6 shadow-2xl relative">
                         <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="xmark" className="w-6 h-6" /></button>
                         <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                             <Icon name="layer-group" className="w-5 h-5 text-emerald-500" /> Dependency Manager
                         </h2>
                         <p className="text-slate-400 text-sm mb-6">
                             You are editing a library mod. This mod is hidden from the main list to keep it clean.
                         </p>
                         
                         <ModCard 
                            mod={mod} 
                            allMods={allMods}
                            isModal={true}
                            onRemove={(id) => {
                                 onRemove(id); // Call standard remove
                                 onClose(); // Force close modal since item is gone
                            }}
                            onUpdateNote={onUpdateNote}
                            {...props}
                         />
                     </div>
                </div>
            );
        };

        // --- Main App ---

        function ModManager() {
          // --- Auth & Routing State ---
          const [user, setUser] = useState(null);
          const [view, setView] = useState('login'); // 'login', 'dashboard', 'create'
          const [accessLevel, setAccessLevel] = useState('guest'); // 'admin', 'user'
          const [serverDocId, setServerDocId] = useState(null);
          const [sessionCodes, setSessionCodes] = useState({ admin: '', user: '' }); // For display to admin
          const [serverName, setServerName] = useState('My Server');
          const [serverIP, setServerIP] = useState('');
          const [panelUrl, setPanelUrl] = useState(''); // NEW: Panel URL state
          const [serverStatus, setServerStatus] = useState(null); // { online: bool, players: {online, max} }

          // --- Data State ---
          const [serverVersion, setServerVersion] = useState('1.21.8');
          const [targetVersion, setTargetVersion] = useState('1.21.10');
          // NEW: Track what version the current list is actually synced to
          const [syncedVersion, setSyncedVersion] = useState(null);
          
          const [loader, setLoader] = useState('fabric');
          const [activeTab, setActiveTab] = useState('active'); // 'active' | 'wishlist'

          const [mods, setMods] = useState([]);
          const [wishlist, setWishlist] = useState([]);

          // --- UI State ---
          const [modInput, setModInput] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [checkingUpdates, setCheckingUpdates] = useState(false);
          const [filter, setFilter] = useState('all'); 
          const [showLibraries, setShowLibraries] = useState(false); // Default HIDDEN
          const [joinCode, setJoinCode] = useState('');
          const [isSyncing, setIsSyncing] = useState(false);
          const [copyFeedback, setCopyFeedback] = useState(false); // Used for Invite Link
          const [ipCopyFeedback, setIpCopyFeedback] = useState(false); // Used for Server IP
          const [adminCodeCopyFeedback, setAdminCodeCopyFeedback] = useState(false);
          const [userCodeCopyFeedback, setUserCodeCopyFeedback] = useState(false);
          const [showScriptModal, setShowScriptModal] = useState(false); 
          const [editingDependencyId, setEditingDependencyId] = useState(null); 
          
          // Custom Mod Modal
          const [showCustomModal, setShowCustomModal] = useState(false);
          // Settings Modal
          const [showSettingsModal, setShowSettingsModal] = useState(false);

          // --- Search State ---
          const [searchResults, setSearchResults] = useState([]);
          const [showDropdown, setShowDropdown] = useState(false);
          const debouncedSearch = useDebounce(modInput, 300);

          // --- Edit IP State ---
          const [isEditingIP, setIsEditingIP] = useState(false);
          const [editIPValue, setEditIPValue] = useState('');

          // --- Creation State ---
          const [newServerName, setNewServerName] = useState('');
          const [newServerIP, setNewServerIP] = useState('');
          
          // --- Local Backup State ---
          const fileInputRef = useRef(null);
          const [importStatus, setImportStatus] = useState(null); // {type: 'success' | 'error', message: string}


          // --- Firebase Auth ---
          useEffect(() => {
            const initAuth = async () => {
              try {
                // Using firebase.auth().signInAnonymously() globally
                await auth.signInAnonymously();
              } catch (e) {
                console.error("Authentication Error:", e);
                setError("Could not sign in. Check console for config errors.");
              }
            };
            initAuth();
            // Using firebase.auth().onAuthStateChanged globally
            return auth.onAuthStateChanged(setUser);
          }, []);

          // --- Server Status Checker ---
          useEffect(() => {
              if (!serverIP || view !== 'dashboard') return;
              
              const checkStatus = async () => {
                  try {
                      // Using mcsrvstat.us public API
                      const res = await fetch(`https://api.mcsrvstat.us/2/${serverIP}`);
                      if (res.ok) {
                          const data = await res.json();
                          setServerStatus({
                              online: data.online,
                              players: data.players,
                              version: data.version
                          });
                      }
                  } catch (e) {
                      console.warn("Failed to check server status", e);
                  }
              };
              
              // Check immediately, then every 60s
              checkStatus();
              const interval = setInterval(checkStatus, 60000);
              return () => clearInterval(interval);
          }, [serverIP, view]);

          // --- CORE JOIN LOGIC (Reusable) ---
          const attemptJoin = useCallback(async (code) => {
            if (!code || !user) return;
            setLoading(true);
            
            try {
              // Accessing firestore globally
              const codeUpper = code.trim().toUpperCase();
              
              const qAdmin = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').where('adminCode', '==', codeUpper).limit(1);
              const qUser = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').where('userCode', '==', codeUpper).limit(1);
              
              let foundDoc = null;
              let role = 'guest';
              let foundCodes = { admin: '', user: '' };

              const adminSnapshot = await qAdmin.get();
              
              if (!adminSnapshot.empty) {
                  adminSnapshot.forEach(doc => {
                    const data = doc.data();
                    foundDoc = doc;
                    role = 'admin';
                    foundCodes = { admin: data.adminCode, user: data.userCode };
                  });
              } else {
                 const userSnapshot = await qUser.get();
                 userSnapshot.forEach(doc => {
                     const data = doc.data();
                     foundDoc = doc;
                     role = 'user';
                     foundCodes = { admin: 'HIDDEN', user: data.userCode };
                 });
              }


              if (foundDoc) {
                setServerDocId(foundDoc.id);
                setAccessLevel(role);
                setSessionCodes(foundCodes);
                // SAVE TO LOCAL STORAGE
                localStorage.setItem('modrinth-server-code', codeUpper);
                
                // DEFAULT TAB LOGIC: Users go to Wishlist, Admins go to Active
                setActiveTab(role === 'admin' ? 'active' : 'wishlist');
                
                setView('dashboard');
              } else {
                setError("Invalid Access Code.");
              }

            } catch (err) {
              console.error(err);
              setError("Failed to join. Connection error.");
            } finally {
              setLoading(false);
            }
          }, [user]);
          
          // --- Auto-Login Effect ---
          useEffect(() => {
            if (!user) return;
            if (serverDocId) return;

            const params = new URLSearchParams(window.location.search);
            const urlCode = params.get('code');
            const storedCode = localStorage.getItem('modrinth-server-code');

            if (urlCode) {
                window.history.replaceState({}, document.title, window.location.pathname);
                attemptJoin(urlCode);
            } else if (storedCode) {
                attemptJoin(storedCode);
            }
          }, [user, serverDocId, attemptJoin]);

          // --- Real-time Listener ---
          useEffect(() => {
            if (!user || !serverDocId) return;

            const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
            
            setIsSyncing(true);
            const unsubscribe = docRef.onSnapshot((docSnap) => {
              if (docSnap.exists) {
                const data = docSnap.data();
                setMods(data.mods || []);
                setWishlist(data.wishlist || []);
                setServerVersion(data.serverVersion || '1.21.8');
                setTargetVersion(data.targetVersion || '1.21.10');
                setServerName(data.serverName || 'My Server');
                setServerIP(data.serverIP || '');
                setPanelUrl(data.panelUrl || ''); // Load panel URL
                // Load synced version from DB, fallback to serverVersion for legacy data
                setSyncedVersion(data.syncedVersion || data.serverVersion || '1.21.8');
                setIsSyncing(false);
              } else {
                setError("Server deleted or unavailable.");
                localStorage.removeItem('modrinth-server-code');
                setView('login');
              }
            }, (err) => {
              console.error("Sync error:", err);
              if (err.code === 'permission-denied') {
                 setError("Permission Denied. Check Firestore Rules.");
              } else {
                 setError(`Connection Error: ${err.message}`);
              }
            });

            return () => unsubscribe();
          }, [user, serverDocId]);

          // --- Search Effect ---
          useEffect(() => {
              if (!debouncedSearch || debouncedSearch.length < 2) {
                  setSearchResults([]);
                  return;
              }

              // Don't search if it looks like a URL or strict ID
              if (debouncedSearch.includes('/') || debouncedSearch.includes('modrinth.com')) {
                  setSearchResults([]);
                  return;
              }

              const doSearch = async () => {
                  try {
                      // Filter for specific loader AND ensure it's a mod (not a modpack/resourcepack)
                      // NEW: Also filter for mods compatible with Server Version OR Target Version
                      // NEW: Also filter for server-side compatibility (required OR optional)
                      const facets = JSON.stringify([
                          [`categories:${loader}`], 
                          ["project_type:mod"],
                          [`versions:${serverVersion}`, `versions:${targetVersion}`],
                          ["server_side:required", "server_side:optional"] 
                      ]);
                      
                      const res = await fetch(`${MODRINTH_API_BASE}/search?query=${debouncedSearch}&limit=5&facets=${facets}`);
                      const data = await res.json();
                      setSearchResults(data.hits || []);
                      setShowDropdown(true);
                  } catch (e) {
                      console.error("Search error", e);
                  }
              };
              doSearch();
          }, [debouncedSearch, loader, serverVersion, targetVersion]);

          // --- Actions ---

          const handleCreateServer = async (e) => {
            e.preventDefault();
            if (!user) {
              setError("Not connected to auth service.");
              return;
            }
            if (!newServerName.trim()) {
                setError("Please provide a Server Name.");
                return;
            }

            setLoading(true);
            setError(null);
            
            const adminCode = generateCode('ADM');
            const userCode = generateCode('USR');
            const newDocId = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).substring(2, 15);

            try {
              // Access firestore globally
              const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(newDocId);
              await docRef.set({
                createdAt: new Date().toISOString(),
                serverName: newServerName.trim(),
                serverIP: newServerIP.trim(),
                adminCode,
                userCode,
                serverVersion: '1.21.8',
                targetVersion: '1.21.10',
                syncedVersion: '1.21.10', // Default initial sync to target
                mods: [],
                wishlist: []
              });

              setServerDocId(newDocId);
              setSessionCodes({ admin: adminCode, user: userCode });
              setAccessLevel('admin');
              setServerName(newServerName.trim());
              setServerIP(newServerIP.trim());
              
              localStorage.setItem('modrinth-server-code', adminCode);
              setActiveTab('active'); // Admins start on active
              
              setView('dashboard');
            } catch (err) {
              console.error("Creation Error:", err);
              if (err.code === 'permission-denied') {
                 setError("Permission Denied. Did you enable Firestore Rules?");
              } else {
                 setError(`Failed to create: ${err.message}`);
              }
            } finally {
              setLoading(false);
            }
          };

          const handleManualJoin = (e) => {
            e.preventDefault();
            attemptJoin(joinCode);
          };

          const handleLogout = () => {
              localStorage.removeItem('modrinth-server-code');
              setServerDocId(null);
              setAccessLevel('guest');
              setView('login');
              setJoinCode('');
          };

          // Updated saveToServer to accept optional syncedVersion override
          const saveToServer = async (newMods, newWishlist, newSyncedVersion = null) => {
            if (!serverDocId) return;
            // Access firestore globally
            const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
            
            const updateData = {
                mods: newMods || mods,
                wishlist: newWishlist || wishlist,
                lastUpdated: new Date().toISOString()
            };
            
            // Only update syncedVersion if explicitly provided (during Check Updates)
            if (newSyncedVersion) {
                updateData.syncedVersion = newSyncedVersion;
            }
            
            await docRef.update(updateData);
          };
          
          const saveVersions = async (sVer, tVer) => {
              if (!serverDocId || accessLevel !== 'admin') return;
              const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
              await docRef.update({
                  serverVersion: sVer,
                  targetVersion: tVer
              });
          }

          const fetchModInfo = async (slug) => {
            const response = await fetch(`${MODRINTH_API_BASE}/project/${slug}`);
            if (!response.ok) throw new Error('Mod not found');
            return await response.json();
          };

          // Improved fetcher to get primary file URL for script
          const fetchModVersions = useCallback(async (slug) => {
            try {
              const query = `?loaders=["${loader}"]&game_versions=${JSON.stringify([serverVersion, targetVersion])}`;
              const response = await fetch(`${MODRINTH_API_BASE}/project/${slug}/version${query}`);
              
              // Gracefully handle rate limits or errors
              if (!response.ok) {
                  console.warn(`Failed to fetch versions for ${slug}: ${response.status}`);
                  return [];
              }
              
              const versions = await response.json();
              
              // Enhance versions with primary file URL
              return versions.map(v => {
                  const primaryFile = v.files.find(f => f.primary) || v.files[0];
                  return {
                      ...v,
                      primary_file_url: primaryFile ? primaryFile.url : null
                  };
              });
            } catch (err) { 
                console.error(err);
                return []; 
            }
          }, [loader, serverVersion, targetVersion]);

          // --- Add Custom Mod Logic ---
          const handleAddCustomMod = async (name, desc, url) => {
              const customSlug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
              const newMod = {
                  id: `custom-${(typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).substring(2, 9)}`,
                  slug: customSlug,
                  title: name,
                  description: desc || 'Custom Uploaded Mod',
                  icon_url: null,
                  isCustom: true,
                  customUrl: url || null,
                  installed_version: 'Custom',
                  target_version_number: 'Custom',
                  project_url: url || null,
                  updated_at: new Date().toISOString(),
                  status: 'ready',
                  note: '',
                  upvotes: [],
                  downvotes: [],
                  enabled: true // Default to enabled
              };

              if (activeTab === 'active') {
                  await saveToServer([...mods, newMod], null);
              } else {
                  await saveToServer(null, [...wishlist, newMod]);
              }
          };

          // --- Mod Logic ---

          const handleAddMod = async (e, manualInput = null, overrideTab = null) => {
            if(e) e.preventDefault();
            const inputVal = manualInput || modInput;

            if (!inputVal.trim()) return;
            
            // Clear search UI immediately
            setSearchResults([]);
            setShowDropdown(false);
            
            const trimmed = inputVal.trim();
            const match = trimmed.match(/modrinth\.com\/[\w-]+\/([^\/?#\s]+)/);
            const cleanSlug = (match ? match[1] : trimmed).toLowerCase();

            if (mods.some(m => m.slug === cleanSlug)) {
              if (!manualInput) setError("This mod is already installed on the Server.");
              return;
            }

            if (activeTab === 'wishlist' && wishlist.some(m => m.slug === cleanSlug)) {
               if (!manualInput) setError("This mod is already in the Wishlist.");
              return;
            }

            setLoading(true);
            if (!manualInput) setError(null);

            try {
              const info = await fetchModInfo(cleanSlug);
              const allVersions = await fetchModVersions(info.slug);
              const serverCandidates = allVersions.filter(v => v.game_versions.includes(serverVersion));
              const targetCandidates = allVersions.filter(v => v.game_versions.includes(targetVersion));
              const latestServer = serverCandidates.length > 0 ? serverCandidates[0] : null;
              const latestTarget = targetCandidates.length > 0 ? targetCandidates[0] : null;

              const newMod = {
                id: info.id,
                slug: info.slug,
                title: info.title,
                icon_url: info.icon_url,
                description: info.description,
                installed_version: latestServer ? latestServer.version_number : 'Not Installed',
                server_candidates: serverCandidates.map(v => v.version_number),
                target_version_number: latestTarget ? latestTarget.version_number : 'None Found',
                target_file_url: latestTarget ? `https://modrinth.com/mod/${info.slug}/version/${latestTarget.version_number}` : null,
                primary_file_url: latestTarget ? latestTarget.primary_file_url : null,
                dependencies: latestServer ? latestServer.dependencies : [],
                project_url: `https://modrinth.com/mod/${info.slug}`,
                updated_at: new Date().toISOString(),
                status: latestTarget ? 'ready' : 'missing',
                note: '',
                upvotes: [], 
                downvotes: [],
                enabled: true // Default to enabled
              };

              const targetList = overrideTab || activeTab;

              if (targetList === 'active') {
                await saveToServer([...mods, newMod], null);
              } else {
                await saveToServer(null, [...wishlist, newMod]);
              }
              setModInput('');
            } catch (err) {
              console.error(err);
              if (!manualInput) setError("Could not find mod. Check slug/url.");
            } finally {
              setLoading(false);
            }
          };

          // --- Deep Link Listener (For Future Extension) ---
          useEffect(() => {
              if (isSyncing) return; // Wait for initial data load to prevent overwrite risks
              
              const params = new URLSearchParams(window.location.search);
              const modToAdd = params.get('add_to_wishlist');
              
              if (modToAdd) {
                  // Clear the param so it doesn't re-trigger on refresh
                  const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                  window.history.replaceState({path: newUrl}, '', newUrl);
                  
                  // Force switch to wishlist view for UX
                  setActiveTab('wishlist');
                  
                  // Trigger add with explicit override to 'wishlist' tab
                  handleAddMod(null, modToAdd, 'wishlist');
              }
          }, [isSyncing]); // Depend on sync status

          const handleRemoveMod = async (id) => {
            if (activeTab === 'active') {
              if (accessLevel !== 'admin') return; 
              const filtered = mods.filter(m => m.id !== id);
              await saveToServer(filtered, null);
            } else {
              const filtered = wishlist.filter(m => m.id !== id);
              await saveToServer(null, filtered);
            }
          };

          const handleApproveWishlist = async (mod) => {
             if (accessLevel !== 'admin') return;
             const newWishlist = wishlist.filter(m => m.id !== mod.id);
             
             let newMods = [...mods];
             if (!mods.some(m => m.slug === mod.slug)) {
                // Clear note and vote data before moving to active
                const { note, noteAuthorId, upvotes, downvotes, ...cleanMod } = mod;
                newMods.push(cleanMod);
             }
             await saveToServer(newMods, newWishlist);
          };
          
          const handleVote = async (modId, type) => {
            if (!user) return;
            const uid = user.uid;
            const updatedWishlist = wishlist.map(m => {
                if (m.id !== modId) return m;
                
                // Safety initialize arrays
                let ups = m.upvotes || [];
                let downs = m.downvotes || [];

                // Check existing votes
                const hadUp = ups.includes(uid);
                const hadDown = downs.includes(uid);

                // Remove user from both arrays initially (reset vote)
                ups = ups.filter(id => id !== uid);
                downs = downs.filter(id => id !== uid);

                // If it was a toggle (e.g. clicked Up when already Up), we leave it removed (neutral).
                // If it was a new vote or a switch, we add it to the correct array.
                
                if (type === 'up' && !hadUp) {
                    ups.push(uid);
                }
                if (type === 'down' && !hadDown) {
                    downs.push(uid);
                }

                return { ...m, upvotes: ups, downvotes: downs };
            });
            await saveToServer(null, updatedWishlist);
          };

          const handleUpdateNote = async (modId, newNote, authorId) => {
              const updatedWishlist = wishlist.map(m => {
                  if (m.id === modId) {
                      const currentAuthor = m.noteAuthorId || authorId;
                      if (m.noteAuthorId && m.noteAuthorId !== authorId && accessLevel !== 'admin') {
                          return m; 
                      }
                      return { ...m, note: newNote, noteAuthorId: currentAuthor };
                  }
                  return m;
              });
              await saveToServer(null, updatedWishlist);
          };

          const handleToggleMod = async (modId) => {
              if (accessLevel !== 'admin') return;
              
              // Only toggle active mods, but safety check for list
              const listToUpdate = activeTab === 'active' ? mods : wishlist;
              
              const updatedList = listToUpdate.map(m => {
                  if (m.id === modId) {
                      // If enabled is undefined, it's effectively true, so we toggle to false. 
                      // If explicitly true, toggle to false. If false, toggle to true.
                      const currentState = m.enabled !== false;
                      return { ...m, enabled: !currentState };
                  }
                  return m;
              });

              if (activeTab === 'active') await saveToServer(updatedList, null);
              else await saveToServer(null, updatedList);
          };

          const handleVersionChange = async (modId, newVersion) => {
            if (activeTab === 'active' && accessLevel !== 'admin') return;

            const list = activeTab === 'active' ? mods : wishlist;
            const updatedList = list.map(mod => {
                if (mod.id === modId) return { ...mod, installed_version: newVersion };
                return mod;
            });

            if (activeTab === 'active') await saveToServer(updatedList, null);
            else await saveToServer(null, updatedList);
          };

          const handleCopyInviteLink = () => {
            const codeToShare = sessionCodes.user; 
            const url = `${window.location.origin}${window.location.pathname}?code=${codeToShare}`;
            const success = copyToClipboard(url);
            if (success) {
              setCopyFeedback(true);
              setTimeout(() => setCopyFeedback(false), 2000);
            }
          };
          
          // FIX: New dedicated handlers for Admin/User Code copies
          const handleCopyAdminCode = () => {
              const success = copyToClipboard(sessionCodes.admin);
              if (success) {
                  setAdminCodeCopyFeedback(true);
                  setTimeout(() => setAdminCodeCopyFeedback(false), 2000);
              }
          };

          const handleCopyUserCode = () => {
              const success = copyToClipboard(sessionCodes.user);
              if (success) {
                  setUserCodeCopyFeedback(true);
                  setTimeout(() => setUserCodeCopyFeedback(false), 2000);
              }
          };

          const handleCopyIP = () => {
            if (!serverIP) return;
            const success = copyToClipboard(serverIP);
            if (success) {
              setIpCopyFeedback(true);
              setTimeout(() => setIpCopyFeedback(false), 2000);
            }
          };

          const handleSaveIP = async () => {
              // Legacy function kept for inline IP edit, but Settings Modal is preferred now
              if (!serverDocId || accessLevel !== 'admin') return;
              try {
                  const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
                  await docRef.update({
                      serverIP: editIPValue.trim()
                  });
                  setIsEditingIP(false);
              } catch (e) {
                  console.error("Failed to update IP:", e);
              }
          };

          const handleSaveSettings = async (newName, newIp, newUrl) => {
               if (!serverDocId || accessLevel !== 'admin') return;
               try {
                  const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
                  await docRef.update({
                      serverName: newName.trim(),
                      serverIP: newIp.trim(),
                      panelUrl: newUrl.trim()
                  });
               } catch(e) {
                   console.error("Failed to save settings:", e);
                   setError("Failed to save settings.");
               }
          };

          // --- Local Backup Handlers ---
          
          const handleExportBackup = () => {
              const data = {
                  modManagerVersion: '1.0',
                  timestamp: new Date().toISOString(),
                  serverName,
                  serverIP,
                  serverVersion,
                  targetVersion,
                  mods,
                  wishlist
              };
              const json = JSON.stringify(data, null, 2);
              const blob = new Blob([json], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `modrinth_manager_backup_${serverName.replace(/\s/g, '_')}_${new Date().toLocaleDateString()}.json`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              setImportStatus({type: 'success', message: 'Backup file downloaded.'});
              setTimeout(() => setImportStatus(null), 3000);
          };
          
          const triggerImport = () => {
              if (accessLevel !== 'admin') return; // Safety check
              fileInputRef.current.click();
          };

          const handleImportBackup = (event) => {
              if (accessLevel !== 'admin') {
                  setImportStatus({type: 'error', message: 'Permission Denied: Only Admins can import data.'});
                  event.target.value = null; 
                  return;
              }

              const file = event.target.files[0];
              if (!file) return;

              const reader = new FileReader();
              reader.onload = async (e) => {
                  try {
                      const content = JSON.parse(e.target.result);
                      
                      if (!content.mods || !content.wishlist) {
                          throw new Error("Invalid file structure. Missing mod lists.");
                      }
                      
                      setServerVersion(content.serverVersion || '1.21.8');
                      setTargetVersion(content.targetVersion || '1.21.10');
                      
                      const docRef = db.collection('artifacts').doc(storageAppId).collection('public').doc('data').collection('servers').doc(serverDocId);
                      await docRef.update({
                          serverName: content.serverName || serverName,
                          serverIP: content.serverIP || serverIP,
                          serverVersion: content.serverVersion || serverVersion,
                          targetVersion: content.targetVersion || targetVersion,
                          mods: content.mods,
                          wishlist: content.wishlist,
                          lastUpdated: new Date().toISOString()
                      });

                      setImportStatus({type: 'success', message: 'Data imported and synced to the server!'});
                      setTimeout(() => setImportStatus(null), 4000);
                  } catch (error) {
                      console.error('Import Error:', error);
                      setImportStatus({type: 'error', message: `Import Failed: ${error.message}`});
                      setTimeout(() => setImportStatus(null), 4000);
                  }
              };
              reader.readAsText(file);
              event.target.value = null; 
          };


          // --- Bulk Check ---
          const checkAllUpdates = useCallback(async (listToUpdate = mods, tab = 'active') => {
            if (listToUpdate.length === 0) return;
            setCheckingUpdates(true);
            
            // RATE LIMIT PROTECTION: Process in batches
            const BATCH_SIZE = 5; 
            const DELAY_MS = 1200; // >1 second delay to be polite
            const delay = (ms) => new Promise(res => setTimeout(res, ms));
            
            // Create a working copy so we can save progress incrementally
            let workingList = [...listToUpdate];

            for (let i = 0; i < listToUpdate.length; i += BATCH_SIZE) {
                const batch = listToUpdate.slice(i, i + BATCH_SIZE);
                
                // Process this batch in parallel
                const results = await Promise.all(batch.map(async (mod) => {
                    // SKIP custom mods during update checks
                    if (mod.isCustom) return mod;

                    try {
                        const allVersions = await fetchModVersions(mod.slug);
                        
                        const serverCandidates = allVersions.filter(v => v.game_versions.includes(serverVersion));
                        const targetCandidates = allVersions.filter(v => v.game_versions.includes(targetVersion));
                        const latestServer = serverCandidates.length > 0 ? serverCandidates[0] : null;
                        const latestTarget = targetCandidates.length > 0 ? targetCandidates[0] : null;
                        
                        const currentInstalled = mod.installed_version === 'Not Installed' && latestServer 
                            ? latestServer.version_number 
                            : mod.installed_version;

                        const versionObj = serverCandidates.find(v => v.version_number === currentInstalled);
                        const currentDependencies = versionObj ? versionObj.dependencies : (mod.dependencies || []);

                        return {
                            ...mod,
                            server_candidates: serverCandidates.map(v => v.version_number),
                            installed_version: currentInstalled,
                            target_version_number: latestTarget ? latestTarget.version_number : 'None Found',
                            target_file_url: latestTarget ? `https://modrinth.com/mod/${mod.slug}/version/${latestTarget.version_number}` : null,
                            primary_file_url: latestTarget ? latestTarget.primary_file_url : null,
                            dependencies: currentDependencies,
                            status: latestTarget ? 'ready' : 'missing',
                            // Preserve existing enable state if not set
                            enabled: mod.enabled !== undefined ? mod.enabled : true
                        };
                    } catch (e) {
                        console.warn(`Skipping ${mod.title} due to error`, e);
                        return mod; // Return original state on error
                    }
                }));

                // Merge batch results back into the working list
                results.forEach(updatedItem => {
                    const index = workingList.findIndex(m => m.id === updatedItem.id);
                    if (index !== -1) workingList[index] = updatedItem;
                });

                // When finishing the last batch for the active list, update the syncedVersion
                const isLastBatch = i + BATCH_SIZE >= listToUpdate.length;
                const newSyncedVersion = (tab === 'active' && isLastBatch) ? targetVersion : null;

                // Save progress to server immediately so users see updates happening
                if (tab === 'active') await saveToServer(workingList, null, newSyncedVersion);
                else await saveToServer(null, workingList);

                // Wait before processing next batch (if there is one)
                if (!isLastBatch) {
                    await delay(DELAY_MS);
                }
            }

            setCheckingUpdates(false);
          }, [fetchModVersions, serverVersion, targetVersion, mods, wishlist]);


          // --- Filter Logic for Libraries ---
          const activeDependencyIds = new Set();
          if (activeTab === 'active') {
              mods.forEach(m => {
                  if (m.dependencies) {
                      m.dependencies.forEach(d => {
                          if (d.dependency_type === 'required') {
                              activeDependencyIds.add(d.project_id);
                          }
                      });
                  }
              });
          }

          // --- Compute the Active Modal Mod LIVE from the List ---
          const activeEditingMod = editingDependencyId 
              ? (activeTab === 'active' ? mods : wishlist).find(m => m.id === editingDependencyId)
              : null;

          // Logic to determine visual warning state
          const isSyncMismatch = activeTab === 'active' && syncedVersion && targetVersion && syncedVersion !== targetVersion;

          // --- Views ---

          if (view === 'login') {
            return (
              <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-slate-200 font-sans">
                <div className="max-w-md w-full space-y-8">
                  <div className="text-center">
                     <div className="inline-flex p-6 bg-emerald-600 rounded-2xl shadow-2xl shadow-emerald-900/50 mb-6">
                        <Icon name="cube" className="text-white text-[64px]" />
                  </div>
                    <h1 className="text-3xl font-bold text-white tracking-tight mb-2">Fabric Mod Manager</h1>
                    <p className="text-slate-400">Track mod updates and sync your modlist with friends.</p>
                  </div>

                  <div className="bg-slate-900 border border-slate-800 rounded-2xl p-8 shadow-xl">
                    <form onSubmit={handleManualJoin} className="space-y-4">
                       <div>
                         <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Access Code</label>
                         <input 
                           type="text" 
                           value={joinCode}
                           onChange={(e) => setJoinCode(e.target.value)}
                           placeholder="e.g. ADM-1234"
                           className="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-3 text-center font-mono text-lg tracking-widest text-white focus:border-emerald-500 focus:outline-none uppercase"
                         />
                       </div>
                       {error && <p className="text-red-400 text-sm text-center flex items-center justify-center gap-2"><Icon name="circle-exclamation" className="w-4 h-4"/> {error}</p>}
                       
                       <Button type="submit" className="w-full py-3" disabled={loading || !joinCode}>
                         {loading ? 'Connecting...' : 'Join Server'}
                       </Button>
                    </form>
                    
                    <div className="relative my-8">
                      <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-800"></div></div>
                      <div className="relative flex justify-center text-sm"><span className="px-2 bg-slate-900 text-slate-600">OR</span></div>
                    </div>

                    <Button variant="outline" onClick={() => setView('create')} className="w-full py-3 border-dashed text-slate-400 hover:text-white hover:border-emerald-500/50">
                       <Icon name="plus" className="w-4 h-4" /> Create New Server
                    </Button>
                  </div>
                </div>
              </div>
            );
          }

          if (view === 'create') {
            return (
              <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 text-slate-200 font-sans">
                <div className="max-w-md w-full space-y-8">
                  <div className="text-center mb-4">
                    <div className="inline-flex p-6 bg-emerald-600 rounded-2xl shadow-2xl shadow-emerald-900/50 mb-6">
                      <Icon name="cube" className="text-white text-[64px]" />
                  </div>
                    <h1 className="text-2xl font-bold text-white tracking-tight">Setup Server</h1>
                    <p className="text-slate-400 text-sm">Create a shared space for your mods.</p>
                  </div>

                  <div className="bg-slate-900 border border-slate-800 rounded-2xl p-8 shadow-xl relative">
                     <button onClick={() => setView('login')} className="absolute top-4 right-4 text-slate-500 hover:text-white"><Icon name="xmark" className="w-5 h-5"/></button>
                     
                     <form onSubmit={handleCreateServer} className="space-y-4">
                        <div>
                           <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Server Name</label>
                           <input 
                             type="text" 
                             value={newServerName}
                             onChange={(e) => setNewServerName(e.target.value)}
                             placeholder="e.g. The Boys SMP"
                             className="w-full bg-slate-950 border border-slate-800 rounded-lg px-4 py-3 text-slate-200 focus:border-emerald-500 focus:outline-none"
                             maxLength={30}
                           />
                        </div>
                        <div>
                           <label className="block text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">Server IP (Optional)</label>
                           <div className="flex items-center gap-2">
                              <div className="bg-slate-950 px-3 py-3 rounded-l-lg border border-slate-800 border-r-0 text-slate-500">
                                 <Icon name="globe" className="w-4 h-4" />
                              </div>
                              <input 
                                type="text" 
                                value={newServerIP}
                                onChange={(e) => setNewServerIP(e.target.value)}
                                placeholder="e.g. play.myserver.com"
                                className="w-full bg-slate-950 border border-slate-800 rounded-r-lg px-4 py-3 text-slate-200 font-mono focus:border-emerald-500 focus:outline-none"
                              />
                           </div>
                        </div>

                        {error && <p className="text-red-400 text-sm text-center flex items-center justify-center gap-2"><Icon name="circle-exclamation" className="w-4 h-4"/> {error}</p>}

                        <Button type="submit" className="w-full py-3 mt-4" disabled={loading || !newServerName}>
                           {loading ? 'Creating...' : 'Create Server'}
                        </Button>
                     </form>
                  </div>
                </div>
              </div>
            )
          }

          const visibleList = activeTab === 'active' ? mods : wishlist;
          const filteredMods = visibleList.filter(mod => {
            if (filter === 'ready' && mod.target_version_number === 'None Found') return false;
            if (filter === 'missing' && mod.target_version_number !== 'None Found') return false;
            if (filter === 'custom' && !mod.isCustom) return false;
            
            if (activeTab === 'active' && !showLibraries && activeDependencyIds.has(mod.id)) {
                return false;
            }
            
            return true;
          });

          const totalMods = visibleList.length;
          const readyMods = visibleList.filter(m => m.target_version_number !== 'None Found').length;
          const percentReady = totalMods === 0 ? 0 : Math.round((readyMods / totalMods) * 100);

          return (
            <div className="min-h-screen bg-slate-900 text-slate-100 font-sans selection:bg-emerald-500/30 pb-20">
              <ScriptModal 
                  isOpen={showScriptModal} 
                  onClose={() => setShowScriptModal(false)} 
                  mods={mods} 
                  targetVersion={targetVersion}
                  syncedVersion={syncedVersion} 
              />
              
              <DependencyModal 
                  mod={activeEditingMod} 
                  allMods={mods}
                  isOpen={!!activeEditingMod} 
                  onClose={() => setEditingDependencyId(null)}
                  activeTab={activeTab}
                  accessLevel={accessLevel}
                  isCheckingUpdates={checkingUpdates}
                  onVersionChange={handleVersionChange}
                  onApprove={handleApproveWishlist}
                  onRemove={handleRemoveMod}
                  onAddDependency={handleAddMod}
                  onEditDependency={setEditingDependencyId}
                  onUpdateNote={handleUpdateNote}
                  onToggle={handleToggleMod}
              />
              
              <CustomModModal
                  isOpen={showCustomModal}
                  onClose={() => setShowCustomModal(false)}
                  onAdd={handleAddCustomMod}
              />
              
              <SettingsModal
                  isOpen={showSettingsModal}
                  onClose={() => setShowSettingsModal(false)}
                  initialName={serverName}
                  initialIP={serverIP}
                  initialUrl={panelUrl}
                  onSave={handleSaveSettings}
              />

              {/* Header */}
              <header className="bg-slate-950 border-b border-slate-800 sticky top-0 z-20">
                <div className="max-w-6xl mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                  <div className="flex items-center gap-4 w-full md:w-auto">
                    <button onClick={handleLogout} className="p-2 hover:bg-slate-800 rounded-lg transition-colors" title="Logout & Clear Session">
                       <Icon name="right-from-bracket" className="w-5 h-5 text-slate-500" />
                    </button>
                    <div>
                      <div className="flex flex-col">
                        <div className="flex items-center gap-3">
                          <h1 className="text-xl font-bold text-white tracking-tight">{serverName}</h1>
                          
                          {/* Admin Settings Button */}
                          {accessLevel === 'admin' && (
                              <button 
                                  onClick={() => setShowSettingsModal(true)}
                                  className="text-slate-500 hover:text-white transition-colors"
                                  title="Server Settings"
                              >
                                  <Icon name="gear" className="w-4 h-4" />
                              </button>
                          )}
                          
                          {/* Live Status Indicator */}
                          {serverIP && serverStatus ? (
                              <div className="flex items-center gap-2 px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 ml-2">
                                  <div className={`w-2 h-2 rounded-full ${serverStatus.online ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`} />
                                  <span className="text-[10px] font-bold text-slate-400">
                                      {serverStatus.online ? `${serverStatus.players.online}/${serverStatus.players.max} Online` : 'Offline'}
                                  </span>
                              </div>
                          ) : (
                              isSyncing ? <Icon name="wifi" className="w-3 h-3 text-emerald-500 animate-pulse ml-2" /> : null
                          )}

                          {/* Quick Console Link (Admin Only) */}
                          {accessLevel === 'admin' && panelUrl && (
                               <a 
                                  href={panelUrl} 
                                  target="_blank" 
                                  rel="noreferrer"
                                  className="ml-2 p-1.5 bg-slate-800 hover:bg-blue-600 text-blue-400 hover:text-white rounded transition-colors"
                                  title="Open PloxHost/Panel Console"
                               >
                                   <Icon name="terminal" className="w-3 h-3" />
                               </a>
                          )}
                        </div>
                        
                        {/* IP Display & Edit (Simplified to read-only since we have settings modal now, click to copy remains) */}
                        {(serverIP) && (
                            <div className="mt-0.5 min-h-[20px]">
                                <div className="flex items-center gap-2 group cursor-pointer" onClick={handleCopyIP} title="Copy IP">
                                    <Icon name="globe" className="w-3 h-3 text-slate-500" />
                                    <span className="text-xs text-slate-500">Server IP:</span> 
                                    <span className="text-xs font-mono text-slate-400 group-hover:text-emerald-400 transition-colors">
                                        {serverIP}
                                    </span>
                                    {ipCopyFeedback ? <Icon name="circle-check" className="w-3 h-3 text-emerald-500" /> : <Icon name="copy" className="w-3 h-3 text-slate-600 opacity-0 group-hover:opacity-100 transition-opacity" />}
                                </div>
                            </div>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-4 w-full md:w-auto justify-end">
                     
                     {/* --- Admin/User Codes Display (Visible on mid/desktop screens) --- */}
                     <div className="hidden md:flex items-center gap-4 mr-4">
                        {/* 1. Admin Code (Admin Only) */}
                        {accessLevel === 'admin' && (
                            <div className="flex items-center gap-2 px-3 py-1 bg-emerald-900/20 border border-emerald-900/50 rounded">
                                <div className="flex flex-col items-end">
                                    <span className="text-[10px] text-emerald-500 font-bold uppercase leading-none">Admin Code</span>
                                    <span className="text-xs text-emerald-400 font-mono font-bold tracking-wider leading-none mt-1">{sessionCodes.admin}</span>
                                </div>
                                
                                {/* FIX: Use button wrapper as provided by user */}
                                {adminCodeCopyFeedback ? (
                                    <Icon name="circle-check" className="w-3 h-3 text-emerald-400" title="Copied!" />
                                ) : (
                                    <button onClick={handleCopyAdminCode} className="p-0 bg-transparent border-0 cursor-pointer hover:opacity-80">
                                        <Icon name="copy" className="w-3 h-3 text-emerald-600" title="Copy Admin Code" />
                                    </button>
                                )}
                            </div>
                        )}

                        {/* 2. User Code (Visible to all connected users) */}
                        {serverDocId && sessionCodes.user !== '' && (
                            <div className="flex items-center gap-2 px-3 py-1 bg-slate-900/50 border border-slate-800 rounded">
                                <div className="flex flex-col items-end">
                                    <span className="text-[10px] text-slate-500 font-bold uppercase leading-none">User Code</span>
                                    <span className="text-xs text-slate-300 font-mono font-bold tracking-wider leading-none mt-1">{sessionCodes.user}</span>
                                </div>
                                
                                {/* FIX: Use button wrapper as provided by user */}
                                {userCodeCopyFeedback ? (
                                    <Icon name="circle-check" className="w-3 h-3 text-emerald-400" title="Copied!" />
                                ) : (
                                    <button onClick={handleCopyUserCode} className="p-0 bg-transparent border-0 cursor-pointer hover:opacity-80">
                                        <Icon name="copy" className="w-3 h-3 text-slate-600 hover:text-white" title="Copy User Code" />
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                    {/* --- End Codes Display --- */}

                     {/* Version Selectors (Read Only for Users, Edit for Admin) */}
                     <div className="flex flex-col items-end group">
                        <label className="text-[10px] uppercase tracking-widest text-slate-500 font-bold">On Server</label>
                        <div className="relative">
                          <select 
                            value={serverVersion} 
                            onChange={(e) => { setServerVersion(e.target.value); saveVersions(e.target.value, targetVersion); }}
                            disabled={accessLevel !== 'admin'}
                            className="appearance-none bg-slate-800 border border-slate-600 text-slate-200 font-mono font-bold py-1.5 pl-3 pr-8 rounded text-sm w-32 disabled:opacity-80 disabled:cursor-not-allowed"
                          >
                            {MC_VERSIONS.map(v => <option key={v} value={v}>{v}</option>)}
                          </select>
                          {accessLevel === 'admin' && <Icon name="chevron-down" className="w-4 h-4 text-slate-500 absolute right-2 top-2 pointer-events-none" />}
                        </div>
                     </div>

                    <Icon name="arrow-right" className="w-5 h-5 text-slate-600 mt-5 hidden md:block" />

                     <div className="flex flex-col items-end group">
                        <label className="text-[10px] uppercase tracking-widest text-emerald-500 font-bold">Target</label>
                        <div className="relative">
                          <select 
                            value={targetVersion} 
                            onChange={(e) => { setTargetVersion(e.target.value); saveVersions(serverVersion, e.target.value); }}
                            disabled={accessLevel !== 'admin'}
                            className="appearance-none bg-slate-900 border border-emerald-500/30 text-emerald-400 font-mono font-bold py-1.5 pl-3 pr-8 rounded text-sm w-32 disabled:opacity-80 disabled:cursor-not-allowed"
                          >
                            {MC_VERSIONS.map(v => <option key={v} value={v}>{v}</option>)}
                          </select>
                          {accessLevel === 'admin' && <Icon name="chevron-down" className="w-4 h-4 text-emerald-500 absolute right-2 top-2 pointer-events-none" />}
                        </div>
                     </div>
                  </div>
                </div>
              </header>

              <main className="max-w-6xl mx-auto px-6 py-8 space-y-8">
                
                {/* List Toggles */}
                <div className="flex justify-center">
                   <div className="bg-slate-800 p-1 rounded-lg inline-flex">
                      <button 
                        onClick={() => setActiveTab('active')}
                        className={`px-6 py-2 rounded-md text-sm font-bold transition-all ${activeTab === 'active' ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}
                      >
                        Server Mods ({mods.length})
                      </button>
                      <button 
                        onClick={() => setActiveTab('wishlist')}
                        className={`px-6 py-2 rounded-md text-sm font-bold transition-all flex items-center gap-2 ${activeTab === 'wishlist' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-400 hover:text-slate-200'}`}
                      >
                        Wishlist ({wishlist.length})
                      </button>
                   </div>
                </div>

                {/* Dashboard Status */}
                {totalMods > 0 && activeTab === 'active' && (
                  <div className={`border rounded-xl p-6 shadow-lg relative overflow-hidden transition-colors duration-300 ${isSyncMismatch ? 'bg-slate-800/50 border-amber-500/50' : 'bg-slate-800 border-slate-700'}`}>
                     <div className="flex flex-col md:flex-row justify-between items-end md:items-center mb-4 gap-4">
                       <div>
                         <h2 className="text-xl font-bold text-white flex items-center gap-2">
                           {isSyncMismatch ? (
                                <Icon name="triangle-exclamation" className="w-5 h-5 text-amber-500 animate-pulse" />
                           ) : (
                                <Icon name="bullseye" className="w-5 h-5 text-emerald-400" />
                           )}
                           Migration Target: <span className={`font-mono ${isSyncMismatch ? 'text-amber-400' : 'text-emerald-400'}`}>{targetVersion}</span>
                         </h2>
                         
                         <p className="text-slate-400 text-sm mt-1 flex items-center gap-2">
                           {isSyncMismatch ? (
                               <span className="text-amber-400 font-bold">
                                    Mismatch! List synced to {syncedVersion}. Click Refresh to sync.
                               </span>
                           ) : (
                               <span>Last Synced: <span className="font-mono text-emerald-400/70">{syncedVersion}</span></span>
                           )}
                         </p>
                       </div>
                       <div className="text-right">
                         <div className="text-3xl font-bold font-mono text-white">{percentReady}%</div>
                       </div>
                    </div>
                    <div className="w-full bg-slate-900 rounded-full h-4 mb-2 overflow-hidden border border-slate-700">
                      <div className={`h-full transition-all duration-1000 ease-out ${readyMods === totalMods ? 'bg-emerald-500' : 'bg-amber-500'}`} style={{ width: `${percentReady}%` }}></div>
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  
                  {/* Add Mod Form */}
                  <Card className="md:col-span-2 p-5 overflow-visible"> 
                     {/* Disable Add to Server if User, Allow Add to Wishlist always */}
                     {(activeTab === 'active' && accessLevel === 'user') ? (
                         <div className="h-full flex flex-col items-center justify-center text-slate-500 py-4">
                            <Icon name="lock" className="w-8 h-8 mb-2 opacity-50" />
                            <p className="text-sm">Only Admins can add directly to Server List.</p>
                            <p className="text-xs">Switch to Wishlist to make a request.</p>
                         </div>
                     ) : (
                        <>
                          <h2 className={`text-sm font-bold uppercase tracking-wider mb-4 flex items-center gap-2 ${activeTab === 'active' ? 'text-emerald-400' : 'text-purple-400'}`}>
                            <Icon name="magnifying-glass" className="w-4 h-4" /> Search {activeTab === 'active' ? 'Server Mods' : 'Wishlist'}
                          </h2>
                          <div className="flex gap-3 relative">
                            <div className="flex-1 relative group">
                              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <Icon name="search" className="text-slate-500" />
                              </div>
                              <input 
                                type="text" 
                                value={modInput}
                                onChange={(e) => {
                                    setModInput(e.target.value);
                                    if(e.target.value.length < 2) setShowDropdown(false);
                                }}
                                onFocus={() => {
                                    if(searchResults.length > 0) setShowDropdown(true);
                                }}
                                onBlur={() => {
                                    // Delay hiding to allow click event on dropdown items
                                    setTimeout(() => setShowDropdown(false), 200);
                                }}
                                placeholder="Search mods (e.g. JEI, Sodium) or paste URL..."
                                className="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-3 text-slate-200 focus:outline-none focus:border-emerald-500 placeholder:text-slate-600 transition-all"
                                autoComplete="off"
                              />
                              
                              {/* Search Dropdown */}
                              {showDropdown && searchResults.length > 0 && (
                                  <div className="absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl z-50 overflow-hidden animate-in fade-in slide-in-from-top-2 duration-200">
                                      <div className="p-2 bg-slate-900/50 border-b border-slate-700">
                                          <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider px-2">Modrinth Results</p>
                                      </div>
                                      {searchResults.map((result) => (
                                          <button
                                              key={result.slug}
                                              className="w-full text-left p-3 hover:bg-slate-700 transition-colors flex items-start gap-3 border-b border-slate-700/50 last:border-0"
                                              onMouseDown={(e) => {
                                                  e.preventDefault(); // Prevent blur
                                                  handleAddMod(null, result.slug);
                                              }}
                                          >
                                              {result.icon_url ? (
                                                  <img src={result.icon_url} className="w-8 h-8 rounded bg-slate-900 object-cover shrink-0" />
                                              ) : (
                                                  <div className="w-8 h-8 rounded bg-slate-900 flex items-center justify-center shrink-0">
                                                      <Icon name="cube" className="w-4 h-4 text-slate-500" />
                                                  </div>
                                              )}
                                              <div className="min-w-0">
                                                  <div className="flex items-center gap-2">
                                                      <span className="font-bold text-slate-200 text-sm truncate">{result.title}</span>
                                                      <span className="text-[10px] bg-slate-900 text-slate-500 px-1.5 rounded">{result.author}</span>
                                                  </div>
                                                  <p className="text-xs text-slate-400 line-clamp-1">{result.description}</p>
                                              </div>
                                          </button>
                                      ))}
                                  </div>
                              )}

                              {error && <div className="absolute -bottom-6 left-0 text-xs text-red-400 flex items-center gap-1"><Icon name="circle-exclamation" className="w-3 h-3" /> {error}</div>}
                            </div>
                            
                            <Button 
                                onClick={() => setShowCustomModal(true)} 
                                variant="outline" 
                                title="Add Custom Mod"
                                className="px-3"
                            >
                                <Icon name="plus" className="w-4 h-4" />
                            </Button>

                            <Button 
                                onClick={(e) => handleAddMod(e)} 
                                disabled={loading || !modInput} 
                                variant={activeTab === 'active' ? 'primary' : 'purple'}
                                className="px-6"
                            >
                              {loading ? <Icon name="arrows-rotate" className="w-4 h-4 animate-spin" /> : <Icon name="plus" className="w-4 h-4" />}
                            </Button>
                          </div>
                        </>
                     )}
                  </Card>

                  {/* Controls */}
                  <Card className="p-5 flex flex-col">
                     <div className="mb-4">
                       <h2 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">Actions</h2>
                       <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          <Button variant="outline" onClick={handleCopyInviteLink} className="text-xs py-2">
                            {copyFeedback ? <Icon name="circle-check" className="w-3 h-3 text-emerald-400" /> : <Icon name="link" className="w-3 h-3" />}
                            {copyFeedback ? 'Copied Link!' : 'Copy Invite Link'}
                          </Button>
                          
                          {/* Admin Only Download Script */}
                          {accessLevel === 'admin' && activeTab === 'active' && (
                             <Button variant="outline" onClick={() => setShowScriptModal(true)} className="text-xs py-2">
                                 <Icon name="terminal" className="w-3 h-3" /> Get Download Script
                             </Button>
                          )}
                          
                          {/* Export (Available to ALL users) */}
                          <Button variant="outline" onClick={handleExportBackup} className="text-xs py-2">
                              <Icon name="file-export" className="w-3 h-3" /> Export Backup
                          </Button>
                          
                          {/* Import (Available only to ADMIN) */}
                          {accessLevel === 'admin' && (
                           <Button variant="outline" onClick={triggerImport} className="text-xs py-2">
                               <Icon name="file-import" className="w-3 h-3" /> Import Backup
                               <input 
                                    type="file" 
                                    ref={fileInputRef} 
                                    onChange={handleImportBackup} 
                                    style={{ display: 'none' }}
                                    accept=".json"
                               />
                           </Button>
                          )}
                           
                           {importStatus && (
                              <div className={`col-span-full text-xs font-medium px-2 py-1 rounded text-center ${importStatus.type === 'success' ? 'bg-emerald-900/50 text-emerald-300' : 'bg-red-900/50 text-red-300'}`}>
                                  {importStatus.message}
                              </div>
                           )}
                       </div>
                     </div>
                     <Button 
                        variant={isSyncMismatch ? 'primary' : 'secondary'} 
                        onClick={() => checkAllUpdates(activeTab === 'active' ? mods : wishlist, activeTab)} 
                        disabled={checkingUpdates || totalMods === 0} 
                        className="w-full mt-auto relative overflow-hidden"
                     >
                       {isSyncMismatch && <div className="absolute inset-0 bg-amber-500/20 animate-pulse pointer-events-none"></div>}
                       <Icon name="arrows-rotate" className={`w-4 h-4 ${checkingUpdates ? 'animate-spin' : ''}`} />
                       {checkingUpdates ? 'Checking...' : isSyncMismatch ? `Force Refresh to ${targetVersion}` : 'Force Refresh'}
                     </Button>
                  </Card>
                </div>

                {/* Mods List */}
                <div className="space-y-4">
                  {/* Filters & Headers (Same as before) */}
                  <div className="flex items-center justify-between px-2">
                    <div className="flex items-center gap-4">
                      <h2 className="text-lg font-medium text-white">
                          {activeTab === 'active' ? 'Active Server Mods' : 'Requested Mods'}
                      </h2>
                      <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                        <button onClick={() => setFilter('all')} className={`px-3 py-1 rounded text-xs font-medium transition-all ${filter === 'all' ? 'bg-slate-600 text-white' : 'text-slate-400 hover:text-white'}`}>All</button>
                        <button onClick={() => setFilter('ready')} className={`px-3 py-1 rounded text-xs font-medium transition-all ${filter === 'ready' ? 'bg-emerald-900/50 text-emerald-400' : 'text-slate-400 hover:text-white'}`}>Ready</button>
                        <button onClick={() => setFilter('missing')} className={`px-3 py-1 rounded text-xs font-medium transition-all ${filter === 'missing' ? 'bg-amber-900/50 text-amber-400' : 'text-slate-400 hover:text-white'}`}>Missing</button>
                        <button onClick={() => setFilter('custom')} className={`px-3 py-1 rounded text-xs font-medium transition-all ${filter === 'custom' ? 'bg-purple-900/50 text-purple-400' : 'text-slate-400 hover:text-white'}`}>Custom</button>
                      </div>
                    </div>
                    
                    {activeTab === 'active' && (
                        <button 
                            onClick={() => setShowLibraries(!showLibraries)} 
                            className="flex items-center gap-2 text-xs font-medium text-slate-500 hover:text-white transition-colors px-3 py-1 rounded-md hover:bg-slate-800"
                        >
                            {showLibraries ? <Icon name="eye" className="w-3 h-3 text-emerald-500" /> : <Icon name="eye-slash" className="w-3 h-3" />}
                            {showLibraries ? 'Hide Libraries' : 'Show Libraries'}
                        </button>
                    )}
                  </div>

                  {totalMods === 0 ? (
                     <div className="text-center py-20 bg-slate-800/50 rounded-xl border border-dashed border-slate-700">
                       <Icon name="cube" className="w-12 h-12 text-slate-600 mx-auto mb-4" />
                       <h3 className="text-slate-300 font-medium">List is empty</h3>
                     </div>
                  ) : (
                    <div className="space-y-3">
                      {filteredMods.map((mod) => (
                        <ModCard 
                            key={mod.id}
                            mod={mod}
                            allMods={mods}
                            isCheckingUpdates={checkingUpdates}
                            accessLevel={accessLevel}
                            activeTab={activeTab}
                            onVersionChange={handleVersionChange}
                            onApprove={handleApproveWishlist}
                            onRemove={handleRemoveMod}
                            onAddDependency={handleAddMod}
                            onEditDependency={setEditingDependencyId}
                            onUpdateNote={handleUpdateNote}
                            currentUser={user}
                            onVote={handleVote}
                            onToggle={handleToggleMod}
                        />
                      ))}
                      {filteredMods.length === 0 && totalMods > 0 && (
                          <div className="text-center py-8 bg-slate-900/50 rounded border border-dashed border-slate-800">
                              <p className="text-slate-500 text-sm">
                                  {showLibraries ? "No mods match filter." : "Hidden libraries are active. Toggle 'Show Libraries' to see them."}
                              </p>
                          </div>
                      )}
                    </div>
                  )}
                </div>
              </main>
            </div>
          );
        }
        
        // --- FINAL RENDER CALL ---
        ReactDOM.createRoot(document.getElementById('root')).render(
            <React.StrictMode>
                <ModManager />
            </React.StrictMode>
        );
    </script>
</body>
</html>
